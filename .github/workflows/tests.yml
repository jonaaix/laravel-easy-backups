# .github/workflows/run-tests.yml
name: Run Tests

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
    workflow_call: { }

jobs:
    test:
        runs-on: ubuntu-latest

        strategy:
            fail-fast: false
            matrix:
                # Wir testen primär PHP 8.4 und Laravel 11/12.
                # Ältere PHP Versionen (8.2/8.3) für Abwärtskompatibilität.
                include:
                    - laravel: 11.*
                      php: 8.2
                    - laravel: 11.*
                      php: 8.3
                    - laravel: 11.*
                      php: 8.4
                    # Laravel 12 Support (experimentell/upcoming)
                    - laravel: 12.*
                      php: 8.4

        name: P${{ matrix.php }} - L${{ matrix.laravel }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: ${{ matrix.php }}
                  # Wichtig: Extensions für alle DB-Treiber aktivieren
                  extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, pdo_mysql, pdo_pgsql, bcmath, soap, intl, gd, exif, iconv
                  coverage: none

            - name: Install Dependencies
              run: |
                  # Wir erzwingen nur die Laravel Version.
                  # Composer löst Testbench und PHPUnit (passend zu Pest v2 -> PHPUnit 10) automatisch auf.
                  composer require "laravel/framework:${{ matrix.laravel }}" --no-interaction --no-update

                  # Install dependencies
                  composer update --prefer-stable --prefer-dist --no-interaction --no-progress

            - name: Make run-tests.sh executable
              run: chmod +x run-tests.sh

            - name: Execute Tests (via Docker)
              run: ./run-tests.sh
